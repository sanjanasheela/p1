@startuml Search_Subsystem_Class_Diagram
!theme plain
skinparam classAttributeIconSize 0
skinparam linetype ortho

title Apache Roller - Search and Indexing Subsystem Class Diagram

package "org.apache.roller.weblogger.business.search" {
    
    interface IndexManager <<interface>> {
        +initialize() : void
        +shutdown() : void
        +release() : void
        +isInconsistentAtStartup() : boolean
        +addEntryIndexOperation(entry: WeblogEntry) : void
        +addEntryReIndexOperation(entry: WeblogEntry) : void
        +removeEntryIndexOperation(entry: WeblogEntry) : void
        +rebuildWeblogIndex(weblog: Weblog) : void
        +rebuildWeblogIndex() : void
        +removeWeblogIndex(weblog: Weblog) : void
        +search(term: String, weblogHandle: String, category: String, locale: String, pageNum: int, entryCount: int, urlStrategy: URLStrategy) : SearchResultList
    }
    
    class SearchResultList {
        -limit : int
        -offset : int
        -categories : Set<String>
        -results : List<WeblogEntryWrapper>
        +SearchResultList(results, categories, limit, offset)
        +getLimit() : int
        +getOffset() : int
        +getResults() : List<WeblogEntryWrapper>
        +getCategories() : Set<String>
    }
    
    class SearchResultMap {
        -limit : int
        -offset : int
        -categories : Set<String>
        -results : Map<Date, Set<WeblogEntryWrapper>>
        +SearchResultMap(results, categories, limit, offset)
        +getLimit() : int
        +getOffset() : int
        +getResults() : Map<Date, Set<WeblogEntryWrapper>>
        +getCategories() : Set<String>
    }
}

package "org.apache.roller.weblogger.business.search.lucene" {
    
    class LuceneIndexManager <<Singleton>> {
        -reader : IndexReader
        -roller : Weblogger
        -{static} logger : Log
        -searchEnabled : boolean
        -indexDir : String
        -indexConsistencyMarker : File
        -inconsistentAtStartup : boolean
        -rwl : ReadWriteLock
        --
        #LuceneIndexManager(roller: Weblogger)
        +initialize() : void
        +shutdown() : void
        +release() : void
        +isInconsistentAtStartup() : boolean
        +rebuildWeblogIndex() : void
        +rebuildWeblogIndex(website: Weblog) : void
        +removeWeblogIndex(website: Weblog) : void
        +addEntryIndexOperation(entry: WeblogEntry) : void
        +addEntryReIndexOperation(entry: WeblogEntry) : void
        +removeEntryIndexOperation(entry: WeblogEntry) : void
        +search(...) : SearchResultList
        +getReadWriteLock() : ReadWriteLock
        +{static} getAnalyzer() : Analyzer
        +resetSharedReader() : void
        +getSharedIndexReader() : IndexReader
        +getIndexDirectory() : Directory
        -scheduleIndexOperation(op: IndexOperation) : void
        -executeIndexOperationNow(op: IndexOperation) : void
        -{static} convertHitsToEntryList(...) : SearchResultList
        -indexExists() : boolean
        -deleteIndex() : void
        -createIndex(dir: Directory) : void
    }
    
    abstract class IndexOperation <<abstract>> implements Runnable {
        #{static} logger : Log
        #manager : LuceneIndexManager
        -writer : IndexWriter
        --
        +IndexOperation(manager: LuceneIndexManager)
        #getDocument(data: WeblogEntry) : Document
        #beginWriting() : IndexWriter
        #endWriting() : void
        +run() : void
        #{abstract} doRun() : void
    }
    
    abstract class WriteToIndexOperation <<abstract>> {
        -{static} logger : Log
        --
        +WriteToIndexOperation(mgr: LuceneIndexManager)
        +run() : void
        #{abstract} doRun() : void
    }
    
    abstract class ReadFromIndexOperation <<abstract>> {
        -{static} logger : Log
        --
        +ReadFromIndexOperation(mgr: LuceneIndexManager)
        +run() : void
        #{abstract} doRun() : void
    }
    
    class AddEntryOperation {
        -{static} logger : Log
        -data : WeblogEntry
        -roller : Weblogger
        --
        +AddEntryOperation(roller: Weblogger, mgr: LuceneIndexManager, data: WeblogEntry)
        +doRun() : void
    }
    
    class RemoveEntryOperation {
        -{static} logger : Log
        -data : WeblogEntry
        -roller : Weblogger
        --
        +RemoveEntryOperation(roller: Weblogger, mgr: LuceneIndexManager, data: WeblogEntry)
        +doRun() : void
    }
    
    class ReIndexEntryOperation {
        -{static} logger : Log
        -data : WeblogEntry
        -roller : Weblogger
        --
        +ReIndexEntryOperation(roller: Weblogger, mgr: LuceneIndexManager, data: WeblogEntry)
        +doRun() : void
    }
    
    class RebuildWebsiteIndexOperation {
        -{static} logger : Log
        -website : Weblog
        -roller : Weblogger
        --
        +RebuildWebsiteIndexOperation(roller: Weblogger, mgr: LuceneIndexManager, website: Weblog)
        +doRun() : void
    }
    
    class RemoveWebsiteIndexOperation {
        -{static} logger : Log
        -website : Weblog
        -roller : Weblogger
        --
        +RemoveWebsiteIndexOperation(roller: Weblogger, mgr: LuceneIndexManager, website: Weblog)
        +doRun() : void
    }
    
    class SearchOperation {
        -{static} logger : Log
        -{static} SEARCH_FIELDS : String[]
        -{static} SORTER : Sort
        -searcher : IndexSearcher
        -searchresults : TopFieldDocs
        -term : String
        -weblogHandle : String
        -category : String
        -locale : String
        -parseError : String
        --
        +SearchOperation(mgr: IndexManager)
        +setTerm(term: String) : void
        +setWeblogHandle(weblogHandle: String) : void
        +setCategory(category: String) : void
        +setLocale(locale: String) : void
        +doRun() : void
        +getSearcher() : IndexSearcher
        +setSearcher(searcher: IndexSearcher) : void
        +getResults() : TopFieldDocs
        +getResultsCount() : int
        +getParseError() : String
    }
    
    class FieldConstants <<final>> {
        +{static} ANCHOR : String = "anchor"
        +{static} UPDATED : String = "updated"
        +{static} ID : String = "id"
        +{static} USERNAME : String = "username"
        +{static} CATEGORY : String = "cat"
        +{static} TITLE : String = "title"
        +{static} PUBLISHED : String = "published"
        +{static} CONTENT : String = "content"
        +{static} CONTENT_STORED : String = "content_stored"
        +{static} C_CONTENT : String = "comment"
        +{static} C_EMAIL : String = "email"
        +{static} C_NAME : String = "name"
        +{static} CONSTANT : String = "constant"
        +{static} CONSTANT_V : String = "v"
        +{static} WEBSITE_HANDLE : String = "handle"
        +{static} LOCALE : String = "locale"
    }
    
    class IndexUtil <<final>> {
        -IndexUtil()
        +{static} getTerm(field: String, input: String) : Term
    }
}

' External dependencies (simplified)
package "Apache Lucene" <<external>> #LightGray {
    class IndexWriter
    class IndexReader
    class IndexSearcher
    class Document
    class Term
    class Analyzer
    class TopFieldDocs
}

package "org.apache.roller.weblogger.pojos" <<external>> #LightBlue {
    class WeblogEntry
    class Weblog
    class WeblogEntryComment
}

' ==================== RELATIONSHIPS ====================

' Interface Implementation
LuceneIndexManager ..|> IndexManager : implements

' Inheritance Hierarchy
WriteToIndexOperation --|> IndexOperation : extends
ReadFromIndexOperation --|> IndexOperation : extends

AddEntryOperation --|> WriteToIndexOperation : extends
RemoveEntryOperation --|> WriteToIndexOperation : extends
ReIndexEntryOperation --|> WriteToIndexOperation : extends
RebuildWebsiteIndexOperation --|> WriteToIndexOperation : extends
RemoveWebsiteIndexOperation --|> WriteToIndexOperation : extends

SearchOperation --|> ReadFromIndexOperation : extends

' Composition/Aggregation
LuceneIndexManager *-- "0..*" IndexOperation : creates >
LuceneIndexManager o-- IndexReader : manages
LuceneIndexManager --> SearchResultList : returns

' Associations
IndexOperation --> LuceneIndexManager : references
IndexOperation --> FieldConstants : uses
IndexOperation ..> Document : creates

AddEntryOperation --> WeblogEntry : indexes
RemoveEntryOperation --> WeblogEntry : removes
ReIndexEntryOperation --> WeblogEntry : re-indexes
RebuildWebsiteIndexOperation --> Weblog : rebuilds for
RemoveWebsiteIndexOperation --> Weblog : removes for

SearchOperation --> IndexSearcher : uses
SearchOperation ..> TopFieldDocs : returns
SearchOperation --> IndexUtil : uses

IndexUtil --> Analyzer : uses
IndexUtil --> Term : creates

' Dependencies
LuceneIndexManager ..> IndexWriter : uses
LuceneIndexManager ..> Analyzer : uses
IndexOperation ..> IndexWriter : uses

note right of LuceneIndexManager
  **Design Patterns:**
  - Singleton (Guice @Singleton)
  - Factory (creates operations)
  - Reader-Writer Lock
end note

note left of IndexOperation
  **Template Method Pattern:**
  - run() calls doRun()
  - Subclasses implement doRun()
end note

note bottom of WriteToIndexOperation
  **Locking Behavior:**
  - Acquires write lock
  - Resets shared reader
  - Exclusive access
end note

note bottom of ReadFromIndexOperation
  **Locking Behavior:**
  - Acquires read lock
  - Allows concurrent reads
end note

@enduml
